<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>System · Cropbox.jl</title><meta name="title" content="System · Cropbox.jl"/><meta property="og:title" content="System · Cropbox.jl"/><meta property="twitter:title" content="System · Cropbox.jl"/><meta name="description" content="Documentation for Cropbox.jl."/><meta property="og:description" content="Documentation for Cropbox.jl."/><meta property="twitter:description" content="Documentation for Cropbox.jl."/><meta property="og:url" content="https://cropbox.github.io/Cropbox.jl/stable/guide/system/"/><meta property="twitter:url" content="https://cropbox.github.io/Cropbox.jl/stable/guide/system/"/><link rel="canonical" href="https://cropbox.github.io/Cropbox.jl/stable/guide/system/"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-192782823-1"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-192782823-1', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Cropbox.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Cropbox.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../">Cropbox</a></li><li><a class="tocitem" href="../../installation/">Installation</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/julia/">Getting started with Julia</a></li><li><a class="tocitem" href="../../tutorials/cropbox/">Getting started with Cropbox</a></li><li><a class="tocitem" href="../../tutorials/makingamodel/">Making a model</a></li><li><a class="tocitem" href="../../tutorials/usingamodel/">Using an existing model</a></li></ul></li><li><span class="tocitem">Manual</span><ul><li class="is-active"><a class="tocitem" href>System</a><ul class="internal"><li><a class="tocitem" href="#Creating-a-System"><span>Creating a System</span></a></li><li><a class="tocitem" href="#Mixin"><span>Mixin</span></a></li><li><a class="tocitem" href="#Context"><span>Context</span></a></li><li><a class="tocitem" href="#Controller"><span>Controller</span></a></li><li><a class="tocitem" href="#Calendar"><span>Calendar</span></a></li></ul></li><li><a class="tocitem" href="../variable/">Variable</a></li><li><a class="tocitem" href="../configuration/">Configuration</a></li><li><a class="tocitem" href="../simulation/">Simulation</a></li><li><a class="tocitem" href="../visualization/">Visualization</a></li><li><a class="tocitem" href="../inspection/">Inspection</a></li></ul></li><li><a class="tocitem" href="../../gallery/">Gallery</a></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../reference/">Index</a></li><li><a class="tocitem" href="../../reference/declaration/">Declaration</a></li><li><a class="tocitem" href="../../reference/simulation/">Simulation</a></li><li><a class="tocitem" href="../../reference/visualization/">Visualization</a></li><li><a class="tocitem" href="../../reference/inspection/">Inspection</a></li></ul></li><li><a class="tocitem" href="../../faq/">Frequently Asked Questions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>System</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>System</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/cropbox/Cropbox.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/cropbox/Cropbox.jl/blob/main/docs/src/guide/system.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="system"><a class="docs-heading-anchor" href="#system">System</a><a id="system-1"></a><a class="docs-heading-anchor-permalink" href="#system" title="Permalink"></a></h1><p>In Cropbox, a system is a unit of model component that contains a collection of variables. The framework guarantees that the most current state of a variable is accessible by another variable that depends on said variable, provided that they are within the same system. To ensure a correct propagation of variable states, the system must have a linear order of computation that satisfies all the requirements for dependency imposed by variable declarations. Any inconsistency caused by a cyclic dependency between variables stops code generation and results in an error. This is intentional, as we want to avoid such logical errors from going through unnoticed. </p><p>Once a system is defined, its structure is fixed and variables cannot be added or removed. The variables themselves, however, can still be updated throughout time steps. Variables declared in another system can be also accessed if the entire system holding dependent variables has already been updated. This is done by declaring an external system as a member of another system.</p><h2 id="Creating-a-System"><a class="docs-heading-anchor" href="#Creating-a-System">Creating a System</a><a id="Creating-a-System-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-a-System" title="Permalink"></a></h2><p>A system in Cropbox is created through the Cropbox-specific macro, <code>@system</code>.</p><pre><code class="nohighlight hljs">@system name[{patches..}][(mixins..)] [&lt;: type] [decl] -&gt; Type{&lt;:System}</code></pre><p><code>@system</code> declares a new system called <code>name</code>, with new variables declared in <code>decl</code> block using a custom syntax. <code>mixins</code> allow specifications of existing systems to be used for the new system. <code>patches</code> may provide type substitution and/or constant definition needed for advanced use. </p><p><strong>Example</strong></p><p>Here is an example of what a simple system may look like.</p><pre><code class="nohighlight hljs">@system begin
    i =&gt; 1 ~ preserve
    a =&gt; 0.1 ~ preserve(parameter)
    r(a, x) =&gt; a*x ~ track
    x(r) ~ accumulate(init = i)
end</code></pre><p>In this system, we declared four <a href="../variable/#variable">variables</a>.</p><ul><li><code>i</code>: variable containing initial value of <code>x</code> which never changes (<em>preserved</em>)</li><li><code>a</code>: variable containing constant <strong>parameter</strong> of exponential growth</li><li><code>r</code>: rate variable which needs to be calculated or <em>tracked</em> every time step</li><li><code>x</code>: state variable which <em>accumulates</em> by rate <code>r</code> over time with initial value <code>i</code></li></ul><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>We can use the Julia macro <code>@macroexpand</code> to see the expression generated by the <code>@system</code> macro.</p></div></div><h2 id="Mixin"><a class="docs-heading-anchor" href="#Mixin">Mixin</a><a id="Mixin-1"></a><a class="docs-heading-anchor-permalink" href="#Mixin" title="Permalink"></a></h2><p>A <code>mixin</code> is a system that is included as a part another system. While each system implements its own set of variables, these variables can be linked with variables from other systems through the use of mixins. <a href="#Controller">Controller</a> is a mixin required to instantiate a system.</p><p><strong>Example</strong></p><p>Here is an example where the system <code>S3</code> is declared with systems <code>S1</code> and <code>S2</code> as mixins.</p><pre><code class="language-julia hljs">@system S1 begin
    a =&gt; 1 ~ preserve(parameter)
    b(a) =&gt; 2a ~ track
end

@system S2 begin
    a =&gt; 2 ~ preserve(parameter)
    b(a, c) =&gt; a*c ~ track
    c =&gt; 1 ~ preserve
end

@system S3(S1, S2, Controller) begin
    d(a) =&gt; 3a ~ preserve
end

instance(S3)</code></pre><table style="font-family: monospace">
<tr style="background-color: transparent">
<td colspan="4" style="text-align: left; padding: 2px; padding-left: 0px; color: rebeccapurple">S3</th>
</tr>
<tr style="background-color: transparent"><td style="text-align: left; padding: 2px; padding-left: 20px; color: royalblue">context</td><td style="text-align: left; padding: 2px 0px 2px 0px; color: gray"></td><td style="text-align: center; padding: 2px 10px 2px 10px; color: gray">=</td><td style="text-align: left; padding: 2px;">&lt;Context&gt;</td></tr>
<tr style="background-color: transparent"><td style="text-align: left; padding: 2px; padding-left: 20px; color: royalblue">config</td><td style="text-align: left; padding: 2px 0px 2px 0px; color: gray"></td><td style="text-align: center; padding: 2px 10px 2px 10px; color: gray">=</td><td style="text-align: left; padding: 2px;">&lt;Config&gt;</td></tr>
<tr style="background-color: transparent"><td style="text-align: left; padding: 2px; padding-left: 20px; color: royalblue">a</td><td style="text-align: left; padding: 2px 0px 2px 0px; color: gray"></td><td style="text-align: center; padding: 2px 10px 2px 10px; color: gray">=</td><td style="text-align: left; padding: 2px;">2.0</td></tr>
<tr style="background-color: transparent"><td style="text-align: left; padding: 2px; padding-left: 20px; color: royalblue">b</td><td style="text-align: left; padding: 2px 0px 2px 0px; color: gray"></td><td style="text-align: center; padding: 2px 10px 2px 10px; color: gray">=</td><td style="text-align: left; padding: 2px;">2.0</td></tr>
<tr style="background-color: transparent"><td style="text-align: left; padding: 2px; padding-left: 20px; color: royalblue">c</td><td style="text-align: left; padding: 2px 0px 2px 0px; color: gray"></td><td style="text-align: center; padding: 2px 10px 2px 10px; color: gray">=</td><td style="text-align: left; padding: 2px;">1.0</td></tr>
<tr style="background-color: transparent"><td style="text-align: left; padding: 2px; padding-left: 20px; color: royalblue">d</td><td style="text-align: left; padding: 2px 0px 2px 0px; color: gray"></td><td style="text-align: center; padding: 2px 10px 2px 10px; color: gray">=</td><td style="text-align: left; padding: 2px;">6.0</td></tr>
</table><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The order of mixins when creating a system is significant. When two variables from two different mixins share a name, the variable from the latter mixin in the system declaration will take priority over the first.</p></div></div><h2 id="Context"><a class="docs-heading-anchor" href="#Context">Context</a><a id="Context-1"></a><a class="docs-heading-anchor-permalink" href="#Context" title="Permalink"></a></h2><p>Whenever a system is constructed in Cropbox, an internal variable named <code>context</code> referencing to an instance of a <code>Context</code> system is included by default. The purpose of the <code>Context</code> system is to manage the time and configuration of a system.</p><p>This is what the <code>Context</code> system looks like:</p><pre><code class="nohighlight hljs">@system Context begin
    context       ~ ::Nothing
    config        ~ ::Config(override)
    clock(config) ~ ::Clock
end</code></pre><p>The variables <code>config</code> and <code>clock</code>, referencing to the systems <code>Config</code> and <code>Clock</code> respectively, are necessary for system instantiation and thus included in every new system by default.</p><h3 id="Clock"><a class="docs-heading-anchor" href="#Clock">Clock</a><a id="Clock-1"></a><a class="docs-heading-anchor-permalink" href="#Clock" title="Permalink"></a></h3><p>Within the <code>Context</code> system, there is a <code>clock</code> variable referring to the <code>Clock</code> system. The <code>Clock</code> system is responsible for keeping track of time-related variables, namely <code>init</code>, <code>step</code>, <code>time</code>, and <code>tick</code>.</p><p>This is what the <code>Clock</code> system looks like:</p><pre><code class="nohighlight hljs">abstract type Clock &lt;: System end
timeunit(::Type{&lt;:Clock}) = u&quot;hr&quot;
@system Clock{timeunit = timeunit(Clock)} begin
    context ~ ::Nothing
    config ~ ::Config(override)
    init =&gt; 0 ~ preserve(unit=timeunit, parameter)
    step =&gt; 1 ~ preserve(unit=timeunit, parameter)
    time =&gt; nothing ~ advance(init=init, step=step, unit=timeunit)
    tick =&gt; nothing ~ advance::int
end</code></pre><p><code>time</code> is an <code>advance</code> variable which is essentially an <code>accumulate</code> variable tailored for keeping time of simulation. By default, <code>time</code> starts at hour 0 and increases by 1-hour intervals. <code>tick</code> is another time variable that is responsible for keeping track of the number of updates performed. As a result, <code>context.clock.time</code> and <code>context.clock.tick</code> are often used as the index for the x-axis of plots and visualizations. The <code>step</code> variable is determines the time-step intervals of simulation. </p><h3 id="Config"><a class="docs-heading-anchor" href="#Config">Config</a><a id="Config-1"></a><a class="docs-heading-anchor-permalink" href="#Config" title="Permalink"></a></h3><p>Unlike the <code>Clock</code> system, the <code>Config</code> referred to by the <code>config</code> variable in <code>Context</code> is not a system. <code>Config</code> is a configuration object structured as a nested dictionary or hash table to store user-defined parameter values as a triplet of <em>system</em> - <em>variable</em> - <em>value</em>. When a configuration object containing specified parameter values are provided to a instantiation of a system, the corresponding variables in the system with the tag <code>parameter</code> will have the configuration values plugged in. Read more about configurations <a href="../configuration/#Configuration1">here</a>.</p><h2 id="Controller"><a class="docs-heading-anchor" href="#Controller">Controller</a><a id="Controller-1"></a><a class="docs-heading-anchor-permalink" href="#Controller" title="Permalink"></a></h2><p>An instance of context and configuration provided to an instance of a new system is usually sourced by a parent system that holds a variable referring to that system. However, because there is no parent system for the instantiation of the first system, context and configuration need to be supplied elsewhere. <code>Controller</code> is a pre-built system of Cropbox made to handle such issues by creating an instance of Context by itself.</p><p>This is what the <code>Controller</code> system looks like:</p><pre><code class="nohighlight hljs">@system Controller begin
    config ~ ::Config(override)
    context(config) ~ ::Context(context)
end</code></pre><p>The <code>Config</code> object referred to by the <code>config</code> variable is overridden by a keyword argument <code>(config)</code> of the system constructor <code>instance()</code> and functions such as <code>simulate()</code> and <code>visualize()</code>. Therefore at least one (and usually only one) system is designated to possess <code>Controller</code> as one of its mixins. In order to run an instance or a simulation of a system, <code>Controller</code> <em>must</em> be included as a mixin. Unlike the system <code>Context</code>, Controller must be explicitly declared as a mixin when declaring a system.</p><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>When you create a system that you want to instantiate, make sure to have <code>Controller</code> as a mixin. You can also make a system instantiable by making a new system with the original system and <code>Controller</code> as mixins.</p></div></div><h2 id="Calendar"><a class="docs-heading-anchor" href="#Calendar">Calendar</a><a id="Calendar-1"></a><a class="docs-heading-anchor-permalink" href="#Calendar" title="Permalink"></a></h2><p><code>Calendar</code> is a system similar to the <code>Clock</code> system. <code>Calendar</code> provides <code>time</code> and <code>step</code> variables, but in the type of ZonedDateTime from <a href="https://github.com/JuliaTime/TimeZones.jl">TimeZones.jl</a>. Much like <code>Clock</code>, <code>Calendar</code> is a pre-built Cropbox system, but <code>Calendar</code> is not included by default as a variable reference like <code>context</code> for the system <code>Context</code>. Also, unlike <code>Clock</code>, <code>Calendar</code> is not embedded in <code>Context</code>.</p><p>This is what the <code>Calendar</code> system looks like:</p><pre><code class="nohighlight hljs">@system Calendar begin
    init ~ preserve::datetime(extern, parameter)
    last =&gt; nothing ~ preserve::datetime(extern, parameter, optional)
    time(t0=init, t=context.clock.time) =&gt; t0 + convert(Cropbox.Dates.Second, t) ~ track::datetime
    date(time) =&gt; Cropbox.Dates.Date(time) ~ track::date
    step(context.clock.step) ~ preserve(u&quot;hr&quot;)
    stop(time, last) =&gt; begin
        isnothing(last) ? false : (time &gt;= last)
    end ~ flag
    count(init, last, step) =&gt; begin
        if isnothing(last)
            nothing
        else
            # number of update!() required to reach `last` time
            (last - init) / step
        end
    end ~ preserve::int(round, optional)
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../tutorials/usingamodel/">« Using an existing model</a><a class="docs-footer-nextpage" href="../variable/">Variable »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.3.0 on <span class="colophon-date" title="Saturday 6 April 2024 16:41">Saturday 6 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
